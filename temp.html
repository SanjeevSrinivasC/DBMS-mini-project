<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Smart Parking Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    h1 { margin-bottom: 0.5rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); gap: 12px; }
    .slot {
      border: 1px solid #ddd; border-radius: 12px; padding: 16px; text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .status { font-size: 0.9rem; margin-top: 8px; }
    .free { background: #e9fbe9; }
    .occ  { background: #ffeaea; }
    .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; background:#999; }
    .dot.free { background:#2e7d32; } .dot.occ { background:#c62828; }
  </style>
</head>
<body>
  <h1>Smart Parking – Live Status</h1>
  <p>Connected: <span id="conn">…</span></p>
  <div id="grid" class="grid"></div>

  <!-- mqtt.js from unpkg (no build tools needed) -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const SLOT_COUNT = 4; // match firmware
    const grid = document.getElementById('grid');
    const conn = document.getElementById('conn');

    // Build cards
    const cards = [];
    for (let i=1;i<=SLOT_COUNT;i++){
      const el = document.createElement('div');
      el.className = 'slot';
      el.innerHTML = `<div class="name">Slot ${i}</div>
        <div class="status"><span class="dot"></span><span class="text">waiting…</span></div>`;
      grid.appendChild(el);
      cards.push(el);
    }

    function setSlot(i, occupied){
      const card = cards[i-1];
      card.classList.remove('free','occ');
      card.classList.add(occupied ? 'occ' : 'free');
      card.querySelector('.dot').className = 'dot ' + (occupied ? 'occ' : 'free');
      card.querySelector('.text').textContent = occupied ? 'Occupied' : 'Free';
    }

    // MQTT over WebSocket
    const clientId = 'web-parking-' + Math.random().toString(16).slice(2);
    const client = mqtt.connect('wss://test.mosquitto.org:8081', { clientId });

    client.on('connect', () => {
      conn.textContent = 'connected';
      for (let i=1;i<=SLOT_COUNT;i++){
        client.subscribe(`parking/slot${i}`);
      }
    });

    client.on('reconnect', ()=> conn.textContent = 'reconnecting…');
    client.on('close',     ()=> conn.textContent = 'disconnected');
    client.on('message', (topic, payload) => {
      const m = topic.match(/slot(\d+)/);
      if (!m) return;
      const idx = parseInt(m[1],10);
      const val = payload.toString(); // "0" or "1"
      setSlot(idx, val === '1');
    });
  </script>
</body>
</html>
